<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker Pro - Multi Color</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å‰å›ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã™ã¹ã¦ç¶™æ‰¿ */
        :root {
            --bg-gradient: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            --card-bg: rgba(255, 255, 255, 0.15);
            --accent-green: #81c784;
            --text-white: #ffffff;
        }
        body { background: var(--bg-gradient); color: var(--text-white); font-family: sans-serif; min-height: 100vh; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); background: rgba(255,255,255,0.3); } 100% { transform: scale(1); } }
        .pop-animation { animation: pop 0.3s ease-out; }
        h1 { font-family: 'Montserrat', sans-serif; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; width: 100%; max-width: 400px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; }
        .add-btn { background: var(--accent-green); border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
        #habitList { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; max-width: 400px; padding: 0; list-style: none; }
        .habit-card { background: var(--card-bg); backdrop-filter: blur(8px); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; transition: all 0.2s; }
        .habit-info { cursor: pointer; margin-bottom: 8px; }
        .habit-name { display: block; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .habit-count { font-size: 0.75rem; opacity: 0.8; }
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px; }
        .action-btn { background: rgba(255,255,255,0.1); border: none; color: white; font-size: 0.6rem; padding: 4px 2px; border-radius: 4px; cursor: pointer; }
        .btn-hide { background: rgba(0,0,0,0.2); }
        .chart-container { background: white; border-radius: 16px; padding: 15px; margin-top: 25px; width: 100%; max-width: 400px; box-sizing: border-box; height: auto; min-height: 320px; }
        .chart-controls { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .chart-controls button { background: #eee; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; color: #333; }
        .chart-controls button.active { background: #455a64; color: white; }
        .archive-section { margin-top: 40px; width: 100%; max-width: 400px; opacity: 0.8; }
        .archive-title { font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; margin-bottom: 10px; }
        .archive-list { list-style: none; padding: 0; }
        .archive-item { background: rgba(0,0,0,0.2); margin-bottom: 5px; padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .archive-name { font-size: 0.85rem; }
        .btn-restore { background: var(--accent-green); border: none; color: white; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; }
        .backup-area { margin: 30px 0; display: flex; gap: 10px; opacity: 0.6; }
        .backup-btn { background: transparent; border: 1px solid white; color: white; font-size: 0.7rem; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Habit tracker</h1>

    <div class="input-group">
        <input type="text" id="habitInput" placeholder="æ–°ã—ã„ç¿’æ…£ã‚’è¿½åŠ ...">
        <button class="add-btn" id="addBtn">ï¼‹</button>
    </div>

    <ul id="habitList"></ul>

    <div class="chart-container">
        <div class="chart-controls">
            <button id="btn-week" class="range-btn active" data-range="week">é€±</button>
            <button id="btn-month" class="range-btn" data-range="month">æœˆ</button>
            <button id="btn-year" class="range-btn" data-range="year">å¹´</button>
        </div>
        <canvas id="habitChart"></canvas>
    </div>

    <div class="archive-section" id="archiveSection" style="display: none;">
        <div class="archive-title">éè¡¨ç¤ºä¸­ã®ç¿’æ…£</div>
        <ul id="archiveList" class="archive-list"></ul>
    </div>

    <div class="backup-area">
        <button class="backup-btn" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—(ä¿å­˜)</button>
        <button class="backup-btn" onclick="document.getElementById('importFile').click()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­è¾¼</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

<script>
    let habitChart;
    // ç‰¹æ®Šæ–‡å­—ã‚’ç„¡å®³ãªæ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function escapeHTML(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }
    let currentRange = 'week';

    // ğŸ¨ 10å€‹ã¾ã§ã¯çµ¶å¯¾ã«è¢«ã‚‰ãªã„ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚ºãƒ‘ãƒ¬ãƒƒãƒˆ
    const colorPalette = [
        '#FF6384', // 1: ãƒ”ãƒ³ã‚¯
        '#36A2EB', // 2: ãƒ–ãƒ«ãƒ¼
        '#FFCE56', // 3: ã‚¤ã‚¨ãƒ­ãƒ¼
        '#4BC0C0', // 4: ã‚¿ãƒ¼ã‚³ã‚¤ã‚º
        '#9966FF', // 5: ãƒ‘ãƒ¼ãƒ—ãƒ«
        '#FF9F40', // 6: ã‚ªãƒ¬ãƒ³ã‚¸
        '#C9CBCF', // 7: ã‚°ãƒ¬ãƒ¼
        '#4D5360', // 8: ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼
        '#81C784', // 9: ã‚°ãƒªãƒ¼ãƒ³
        '#F06292'  // 10: ãƒ©ã‚¤ãƒˆãƒ”ãƒ³ã‚¯
    ];

    window.onload = () => {
        renderHabits();
        initChart();
        document.getElementById('addBtn').addEventListener('click', addHabit);
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', (e) => changeRange(e.target.dataset.range));
        });
    };

    function getHabits() {
        return JSON.parse(localStorage.getItem('habitsV2')) || [];
    }

    function saveAndRefresh(habits) {
        localStorage.setItem('habitsV2', JSON.stringify(habits));
        renderHabits();
        updateChart(currentRange);
    }

    function addHabit() {
        const input = document.getElementById('habitInput');
        if (!input.value.trim()) return;
        const habits = getHabits();
        
        // è‰²ã‚’å‰²ã‚Šå½“ã¦ï¼ˆæ—¢å­˜ã®æ•°ã«åŸºã¥ã„ã¦ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰é¸æŠï¼‰
        const nextColor = colorPalette[habits.length % colorPalette.length];
        
        habits.push({ 
            name: input.value, 
            color: nextColor, 
            logs: [],
            archived: false 
        });
        input.value = "";
        saveAndRefresh(habits);
    }

    // è¨˜éŒ²ã€å–æ¶ˆã€éè¡¨ç¤ºã€å‰Šé™¤ã®é–¢æ•°ï¼ˆå‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿ï¼‰
    function logHabit(index, event) {
        const habits = getHabits();
        habits[index].logs.push(new Date().toISOString());
        const card = event.currentTarget.closest('.habit-card');
        card.classList.remove('pop-animation');
        void card.offsetWidth; 
        card.classList.add('pop-animation');
        saveAndRefresh(habits);
    }

    function undoHabit(index, e) {
        e.stopPropagation();
        const habits = getHabits();
        if (habits[index].logs.length > 0 && confirm("æœ€æ–°ã®è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
            habits[index].logs.pop();
            saveAndRefresh(habits);
        }
    }

    function toggleArchive(index, e) {
        e.stopPropagation();
        const habits = getHabits();
        habits[index].archived = !habits[index].archived;
        saveAndRefresh(habits);
    }

    function deleteHabit(index, e) {
        e.stopPropagation();
        if (confirm("ã“ã®ç¿’æ…£ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const habits = getHabits();
            habits.splice(index, 1);
            saveAndRefresh(habits);
        }
    }

    function renderHabits() {
        const habits = getHabits();
        const today = new Date().toDateString();
        const habitListEl = document.getElementById('habitList');
        const archiveListEl = document.getElementById('archiveList');
        const archiveSection = document.getElementById('archiveSection');
        let activeHtml = "";
        let archiveHtml = "";
        let archiveCount = 0;

        habits.forEach((h, i) => {
            if (!h.archived) {
                const todayCount = h.logs.filter(l => new Date(l).toDateString() === today).length;
                activeHtml += `
                    <li class="habit-card">
                        <div class="habit-info" onclick="logHabit(${i}, event)">
                            <span class="habit-name">${escapeHTML(h.name)}</span>
                            <span class="habit-count">ä»Šæ—¥: ${todayCount}å›</span>
                        </div>
                        <div class="card-actions">
                            <button class="action-btn" onclick="undoHabit(${i}, event)">æˆ»ã™</button>
                            <button class="action-btn btn-hide" onclick="toggleArchive(${i}, event)">éè¡¨ç¤º</button>
                            <button class="action-btn" onclick="deleteHabit(${i}, event)" style="grid-column: span 2; color:#ff8a65">å‰Šé™¤</button>
                        </div>
                    </li>
                `;
            } else {
                archiveCount++;
                archiveHtml += `
                    <li class="archive-item">
                        <span class="archive-name">${escapeHTML(h.name)}</span>
                        <button class="btn-restore" onclick="toggleArchive(${i}, event)">è¡¨ç¤ºã™ã‚‹</button>
                    </li>
                `;
            }
        });
        habitListEl.innerHTML = activeHtml;
        archiveListEl.innerHTML = archiveHtml;
        archiveSection.style.display = archiveCount > 0 ? 'block' : 'none';
    }

    function initChart() {
        const ctx = document.getElementById('habitChart').getContext('2d');
        habitChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 1.2,
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
        updateChart('week');
    }

    function changeRange(range) {
        currentRange = range;
        document.querySelectorAll('.range-btn').forEach(b => b.classList.toggle('active', b.dataset.range === range));
        updateChart(range);
    }

    function updateChart(range) {
        const habits = getHabits().filter(h => !h.archived); 
        const labels = [];
        const count = range === 'week' ? 7 : (range === 'month' ? 30 : 12);
        const now = new Date();

        for(let i = count - 1; i >= 0; i--) {
            let d = new Date();
            if(range === 'year') d.setMonth(now.getMonth() - i); else d.setDate(now.getDate() - i);
            labels.push(range === 'year' ? `${d.getMonth()+1}æœˆ` : `${d.getMonth()+1}/${d.getDate()}`);
        }

        habitChart.data.labels = labels;
        habitChart.data.datasets = habits.map((h, index) => {
            const data = new Array(count).fill(0);
            h.logs.forEach(log => {
                const lD = new Date(log);
                for(let i=0; i<count; i++){
                    let t = new Date();
                    if(range === 'year') {
                        t.setMonth(now.getMonth()-(count-1-i));
                        if(lD.getFullYear()===t.getFullYear() && lD.getMonth()===t.getMonth()) data[i]++;
                    } else {
                        t.setDate(now.getDate()-(count-1-i));
                        if(lD.toDateString()===t.toDateString()) data[i]++;
                    }
                }
            });
            // ã‚°ãƒ©ãƒ•æç”»æ™‚ã«è‰²ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰ç¢ºå®Ÿã«å‰²ã‚Šå½“ã¦
            return { 
                label: h.name, 
                data: data, 
                backgroundColor: h.color || colorPalette[index % colorPalette.length], 
                borderRadius: 4 
            };
        });
        habitChart.update();
    }

    function exportData() {
        const data = localStorage.getItem('habitsV2');
        if(!data) return;
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `habit_tracker_backup.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            if(confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")){
                localStorage.setItem('habitsV2', ev.target.result);
                location.reload();
            }
        };
        reader.readAsText(e.target.files[0]);
    }
</script>
</body>
</html>