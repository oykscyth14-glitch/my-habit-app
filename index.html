<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            --card-bg: rgba(255, 255, 255, 0.15);
            --accent-green: #81c784;
            --text-white: #ffffff;
        }

        body {
            background: var(--bg-gradient); color: var(--text-white);
            font-family: sans-serif; min-height: 100vh; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* アニメーション定義 */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(255,255,255,0.3); }
            100% { transform: scale(1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        h1 { font-family: 'Montserrat', sans-serif; margin-bottom: 20px; }

        .input-group { margin-bottom: 20px; width: 100%; max-width: 400px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; }
        .add-btn { background: var(--accent-green); border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }

        #habitList {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            width: 100%; max-width: 400px; padding: 0; list-style: none;
        }

        .habit-card {
            background: var(--card-bg); backdrop-filter: blur(8px); border-radius: 12px;
            padding: 12px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; transition: all 0.2s;
        }

        .habit-info { cursor: pointer; margin-bottom: 8px; }
        .habit-name { display: block; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .habit-count { font-size: 0.75rem; opacity: 0.8; }

        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px; }
        .action-btn {
            background: rgba(255,255,255,0.1); border: none; color: white;
            font-size: 0.6rem; padding: 4px 2px; border-radius: 4px; cursor: pointer;
        }
        .btn-archive { background: rgba(0,0,0,0.2); }

        .chart-container {
            background: white; border-radius: 16px; padding: 15px; margin-top: 25px;
            width: 100%; max-width: 400px; box-sizing: border-box; height: auto; min-height: 320px;
        }
        .chart-controls { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .chart-controls button {
            background: #eee; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; color: #333;
        }
        .chart-controls button.active { background: #455a64; color: white; }

        .backup-area { margin: 30px 0; display: flex; gap: 10px; opacity: 0.6; }
        .backup-btn { background: transparent; border: 1px solid white; color: white; font-size: 0.7rem; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Habit tracker</h1>

    <div class="input-group">
        <input type="text" id="habitInput" placeholder="新しい習慣を追加...">
        <button class="add-btn" id="addBtn">＋</button>
    </div>

    <ul id="habitList"></ul>

    <div class="chart-container">
        <div class="chart-controls">
            <button id="btn-week" class="range-btn active" data-range="week">週</button>
            <button id="btn-month" class="range-btn" data-range="month">月</button>
            <button id="btn-year" class="range-btn" data-range="year">年</button>
        </div>
        <canvas id="habitChart"></canvas>
    </div>

    <div class="backup-area">
        <button class="backup-btn" onclick="exportData()">データを保存</button>
        <button class="backup-btn" onclick="document.getElementById('importFile').click()">復元</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

<script>
    let habitChart;
    let currentRange = 'week';
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#81C784', '#F48FB1', '#80DEEA', '#D4E157'];

    window.onload = () => {
        renderHabits();
        initChart();
        document.getElementById('addBtn').addEventListener('click', addHabit);
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', (e) => changeRange(e.target.dataset.range));
        });
    };

    function getHabits() {
        return JSON.parse(localStorage.getItem('habitsV2')) || [];
    }

    function saveAndRefresh(habits) {
        localStorage.setItem('habitsV2', JSON.stringify(habits));
        renderHabits();
        updateChart(currentRange);
    }

    function addHabit() {
        const input = document.getElementById('habitInput');
        if (!input.value.trim()) return;
        const habits = getHabits();
        habits.push({ 
            name: input.value, 
            color: colors[habits.length % colors.length], 
            logs: [],
            archived: false 
        });
        input.value = "";
        saveAndRefresh(habits);
    }

    function logHabit(index, event) {
        const habits = getHabits();
        habits[index].logs.push(new Date().toISOString());
        
        // アニメーション適用
        const card = event.currentTarget.closest('.habit-card');
        card.classList.remove('pop-animation');
        void card.offsetWidth; // リフロー強制
        card.classList.add('pop-animation');

        saveAndRefresh(habits);
    }

    function undoHabit(index, e) {
        e.stopPropagation();
        const habits = getHabits();
        if (habits[index].logs.length > 0 && confirm("最新の記録を取り消しますか？")) {
            habits[index].logs.pop();
            saveAndRefresh(habits);
        }
    }

    function toggleArchive(index, e) {
        e.stopPropagation();
        const habits = getHabits();
        habits[index].archived = !habits[index].archived;
        saveAndRefresh(habits);
    }

    function deleteHabit(index, e) {
        e.stopPropagation();
        if (confirm("この習慣を完全に削除しますか？")) {
            const habits = getHabits();
            habits.splice(index, 1);
            saveAndRefresh(habits);
        }
    }

    function renderHabits() {
        const habits = getHabits();
        const today = new Date().toDateString();
        // 非アーカイブのみ表示
        document.getElementById('habitList').innerHTML = habits.map((h, i) => h.archived ? '' : `
            <li class="habit-card">
                <div class="habit-info" onclick="logHabit(${i}, event)">
                    <span class="habit-name">${h.name}</span>
                    <span class="habit-count">今日: ${h.logs.filter(l => new Date(l).toDateString() === today).length}回</span>
                </div>
                <div class="card-actions">
                    <button class="action-btn" onclick="undoHabit(${i}, event)">戻す</button>
                    <button class="action-btn btn-archive" onclick="toggleArchive(${i}, event)">完了</button>
                    <button class="action-btn" onclick="deleteHabit(${i}, event)" style="grid-column: span 2; color:#ff8a65">削除</button>
                </div>
            </li>
        `).join('');
    }

    function initChart() {
        const ctx = document.getElementById('habitChart').getContext('2d');
        habitChart = new Chart(ctx, {
            type: 'bar', // 棒グラフに変更
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.2,
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                },
                scales: {
                    x: { stacked: true }, // 積み上げ設定
                    y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
        updateChart('week');
    }

    function changeRange(range) {
        currentRange = range;
        document.querySelectorAll('.range-btn').forEach(b => b.classList.toggle('active', b.dataset.range === range));
        updateChart(range);
    }

    function updateChart(range) {
        const habits = getHabits().filter(h => !h.archived); // アーカイブ以外
        const labels = [];
        const count = range === 'week' ? 7 : (range === 'month' ? 30 : 12);
        const now = new Date();

        for(let i = count - 1; i >= 0; i--) {
            let d = new Date();
            if(range === 'year') d.setMonth(now.getMonth() - i); else d.setDate(now.getDate() - i);
            labels.push(range === 'year' ? `${d.getMonth()+1}月` : `${d.getMonth()+1}/${d.getDate()}`);
        }

        habitChart.data.labels = labels;
        habitChart.data.datasets = habits.map(h => {
            const data = new Array(count).fill(0);
            h.logs.forEach(log => {
                const lD = new Date(log);
                for(let i=0; i<count; i++){
                    let t = new Date();
                    if(range === 'year') {
                        t.setMonth(now.getMonth()-(count-1-i));
                        if(lD.getFullYear()===t.getFullYear() && lD.getMonth()===t.getMonth()) data[i]++;
                    } else {
                        t.setDate(now.getDate()-(count-1-i));
                        if(lD.toDateString()===t.toDateString()) data[i]++;
                    }
                }
            });
            return { label: h.name, data: data, backgroundColor: h.color, borderRadius: 4 };
        });
        habitChart.update();
    }

    function exportData() {
        const data = localStorage.getItem('habitsV2');
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `habits_backup.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            if(confirm("データを復元しますか？")){
                localStorage.setItem('habitsV2', ev.target.result);
                location.reload();
            }
        };
        reader.readAsText(e.target.files[0]);
    }
</script>
</body>
</html>